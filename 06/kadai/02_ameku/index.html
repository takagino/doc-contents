<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>p5play</title>
    <style>
      canvas {
        border: 1px solid #aaa;
      }
    </style>
  </head>
  <body>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.11.4/lib/p5.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.11.4/lib/addons/p5.sound.min.js"></script>
    <!-- planck -->
    <script src="https://cdn.jsdelivr.net/npm/planck@latest/dist/planck.min.js"></script>
    <!-- Version 3 of p5.play -->
    <script src="https://p5play.org/v3/p5play.js"></script>
    <script>
      let player, floor;
      let enemies;
      let isGameOver = false;
      let playerImg, enemyImg;
      let jumpCount = 0;
      let nextEnemyTime = 0;
      let hearts = 3;
      let isInvincible = false;
      let invincibleEndTime = 0;

      function preload() {
        playerImg = loadImage("player.svg");
        enemyImg = loadImage("enemy.svg");
      }

      function setup() {
        createCanvas(640, 480);
        world.gravity.y = 10;

        player = new Sprite(100, 300);
        player.image = playerImg;
        player.scale = 0.1;
        player.layer = 2;

        floor = new Sprite(320, 400, 500, 30);
        floor.color = "#666";
        floor.collider = "static";
        floor.layer = 1;

        enemies = new Group();
        enemies.image = enemyImg;
        enemies.collider = "kinematic";
      }

      function draw() {
        background(255);
        fill(255, 0, 0);
        textSize(24);
        textAlign(LEFT);
        text("❤️ × " + hearts, 20, 40);

        if (isGameOver) {
          fill(0);
          textSize(50);
          textAlign(CENTER);
          text("GAME OVER", width / 2, height / 2);
          return;
        }

        if (kb.pressing("right")) {
          player.vel.x = 5;
        } else if (kb.pressing("left")) {
          player.vel.x = -5;
        } else {
          player.vel.x = 0;
        }

        if (player.colliding(floor)) {
          jumpCount = 0;
        }
        if (kb.presses("up") && jumpCount < 2) {
          player.vel.y = -5;
          jumpCount++;
        }

        if (frameCount >= nextEnemyTime) {
          let enemy = new enemies.Sprite(width, 380);
          let randomScale = random(0.05, 0.3);
          enemy.scale = randomScale;
          enemy.vel.x = -random(3, 10);
          nextEnemyTime = frameCount + Math.floor(random(50, 180));
        }

        enemies.cull(100);

        if (isInvincible && millis() > invincibleEndTime) {
          isInvincible = false;
          player.tint = "";
        }

        if (!isInvincible && player.collides(enemies)) {
          hearts--;
          isInvincible = true;
          invincibleEndTime = millis() + 3000;
          player.tint = "#666";
          if (hearts <= 0) {
            isGameOver = true;
          }
        }
        if (
          !isGameOver &&
          (player.y > height + 50 || // OR＝||
            player.y < -50 ||
            player.x < -50 ||
            player.x > width + 50)
        ) {
          isGameOver = true;
        }
      }
    </script>
  </body>
</html>
