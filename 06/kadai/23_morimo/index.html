<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>p5play</title>
    <style>
      canvas {
        border: 1px solid #aaa;
      }
    </style>
  </head>
  <body>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.11.4/lib/p5.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.11.4/lib/addons/p5.sound.min.js"></script>
    <!-- planck -->
    <script src="https://cdn.jsdelivr.net/npm/planck@latest/dist/planck.min.js"></script>
    <!-- Version 3 of p5.play -->
    <script src="https://p5play.org/v3/p5play.js"></script>
    <script>
      let player, floor;
      let enemies;
      let fallingEnemies;
      let isGameOver = false;
      let score = 0;

      let playerImg;
      let enemyImg;

      function preload() {
        playerImg = loadImage("player.svg");
        enemyImg = loadImage("enemy.svg");
      }

      function setup() {
        createCanvas(640, 480);
        world.gravity.y = 10;

        // --- 床 ---
        floor = new Sprite(320, 400, 800, 30);
        floor.color = "#666";
        floor.collider = "static";

        // --- プレイヤー ---
        player = new Sprite(100, 350);
        player.image = playerImg;
        player.scale = 0.1;
        player.rotationLock = true;

        // --- 敵グループ（横から） ---
        enemies = new Group();
        enemies.image = enemyImg;
        enemies.scale = 0.1;
        enemies.collider = "kinematic";

        // --- 敵グループ（上から） ---
        fallingEnemies = new Group();
        fallingEnemies.image = enemyImg;
        fallingEnemies.scale = 0.1;
        fallingEnemies.collider = "dynamic";
      }

      function draw() {
        background(255);

        // --- スコア表示 ---
        if (!isGameOver) {
          score = Math.floor(frameCount / 60);
        }
        fill(0);
        textSize(20);
        textAlign(LEFT);
        text("Score: " + score, 20, 30);

        if (isGameOver) {
          fill(0);
          textSize(50);
          textAlign(CENTER);
          text("GAME OVER", width / 2, height / 2);

          textSize(25);
          text("Press SPACE to restart", width / 2, height / 2 + 50);

          if (kb.presses("space")) {
            // リセット処理
            isGameOver = false;
            player.pos = { x: 100, y: 350 };
            player.tint = color(255);
            enemies.removeAll();
            fallingEnemies.removeAll();
            frameCount = 0;
            score = 0;
          }
          return;
        }

        fallingEnemies.overlaps(enemies);
        fallingEnemies.overlaps(floor);

        // --- プレイヤー操作 ---
        if (kb.pressing("right")) {
          player.vel.x = 5;
        } else if (kb.pressing("left")) {
          player.vel.x = -5;
        } else {
          player.vel.x = 0;
        }

        if (player.x < 0) {
          player.x = 0;
          player.vel.x = 0;
        } else if (player.x > width) {
          player.x = width;
          player.vel.x = 0;
        }

        if (kb.presses("up") && player.colliding(floor)) {
          player.vel.y = -5;
        }

        // --- 敵の生成頻度 ---
        let baseInterval = 60;
        let scoreFactor = Math.floor(score / 10);
        let newInterval = Math.max(baseInterval - scoreFactor * 5, 15);

        // --- 横からくる敵の生成 ---
        if (frameCount % 120 === 0) {
          let enemy = new enemies.Sprite(width, 380);
          enemy.vel.x = -5;
        }

        // --- 上から降る敵の生成 ---
        if (frameCount % newInterval === 0) {
          let randX = random(width);
          let fallingEnemy = new fallingEnemies.Sprite(randX, 0);
        }

        // --- 敵の消滅処理 ---
        enemies.cull(100);
        fallingEnemies.collides(floor, (enemy, ground) => {
          enemy.remove();
        });

        // --- 衝突判定（ゲームオーバー） ---
        if (player.collides(enemies) || player.collides(fallingEnemies)) {
          isGameOver = true;
          player.tint = "#666";
        }
      }
    </script>
  </body>
</html>
