<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>ゲーム</title>
    <style>
        canvas {
            border: 1px solid #aaa;
        }
    </style>
</head>

<body>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.11.4/lib/p5.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.11.4/lib/addons/p5.sound.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/planck@latest/dist/planck.min.js"></script>
    <script src="https://p5play.org/v3/p5play.js"></script>

    <script>
        let player, floor;
        let enemies, fallingEnemies, items;
        let clouds = [];
        let isGameOver = false;
        let score = 0;
        let life = 3;
        let powerUp = false;
        let powerUpTimer = 0;
        let invincible = false;
        let invincibleTimer = 0;
        let hitEffects = [];

        function preload() {
            playerImg = loadImage('player.svg');
            enemyImg = loadImage('enemy.svg');
            itemImg = loadImage('item.svg');
        }

        function setup() {
            createCanvas(640, 480);
            world.gravity.y = 10;

            floor = new Sprite(320, 400, 500, 30);
            floor.color = '#666';
            floor.collider = 'static';

            let playerScale = 0.1;
            let playerHeight = playerImg.height * playerScale;
            player = new Sprite(100, floor.pos.y - floor.height / 2 - playerHeight / 2);
            player.image = playerImg;
            player.rotationLock = true;
            player.scale = playerScale;

            enemies = new Group(); enemies.image = enemyImg; enemies.collider = 'kinematic'; enemies.scale = 0.1;
            fallingEnemies = new Group(); fallingEnemies.image = enemyImg; fallingEnemies.collider = 'kinematic'; fallingEnemies.scale = 0.1;
            items = new Group(); items.image = itemImg; items.collider = 'kinematic'; items.scale = 0.1;

            for (let i = 0; i < 5; i++) {
                clouds.push({ x: random(width), y: random(50, 150), size: random(50, 100) });
            }
        }

        function showHitEffect(x, y) {
            hitEffects.push({ x: x, y: y, size: 20, alpha: 150 });
        }

        function showItemEffect(x, y) {
            for (let i = 0; i < 5; i++) {
                hitEffects.push({
                    x: x + random(-10, 10),
                    y: y + random(-10, 10),
                    size: 5,
                    alpha: 255,
                    color: [random(255), random(255), 0]
                });
            }
        }

        function draw() {
            background(135, 206, 235);

            fill(255); noStroke();
            for (let cloud of clouds) {
                ellipse(cloud.x, cloud.y, cloud.size, cloud.size * 0.6);
                cloud.x -= 1;
                if (cloud.x < -cloud.size) cloud.x = width + cloud.size;
            }

            fill(180, 240, 180);
            rect(0, floor.pos.y, width, height - floor.pos.y);

            fill(0); textSize(24); textAlign(LEFT);
            text('Score:' + score, 10, 30);
            text('Life:' + life, 10, 60);
            if (powerUp) text('POWER-UP!', 10, 90);
            if (invincible) text('INVINCIBLE!', 10, 120);

            if (isGameOver) {
                fill(0); textSize(50); textAlign(CENTER);
                text('GAME OVER', width / 2, height / 2);
                textSize(24); text('Press SPACE to restart', width / 2, height / 2 + 50);
                return;
            }

            if (frameCount % 30 === 0) score += 1;

            if (!(invincible || powerUp)) {
                player.vel.x = 0;
                if (kb.pressing('right')) player.vel.x = 5;
                if (kb.pressing('left')) player.vel.x = -5;
                if (kb.presses('up') && player.colliding(floor)) player.vel.y = -6;
            } else {
                player.vel.set(0, 0);
            }

            if (frameCount % 120 === 0) { let e = new enemies.Sprite(width, floor.pos.y - 20); e.vel.x = -5; }
            if (frameCount % 180 === 0) { let f = new fallingEnemies.Sprite(random(50, width - 50), -20); f.vel.y = 3 + random(0, 2); }
            if (frameCount % 600 === 0) { let item = new items.Sprite(width, random(200, floor.pos.y - 50)); item.vel.x = -3; }

            enemies.cull(100); fallingEnemies.cull(100); items.cull(50);

            player.overlap(enemies, (p, e) => {
                if (invincible || powerUp) {
                    showHitEffect(e.pos.x, e.pos.y);
                    e.remove();
                    score += 1;
                } else {
                    life -= 1;
                    showHitEffect(player.pos.x, player.pos.y);
                    if (life <= 0) {
                        isGameOver = true;
                        player.vel.set(0, 0);
                    } else {
                        invincible = true;
                        invincibleTimer = frameCount;
                        player.pos.set(100, floor.pos.y - playerImg.height * player.scale / 2);
                    }
                }
            });

            player.overlap(fallingEnemies, (p, f) => {
                if (invincible || powerUp) {
                    showHitEffect(f.pos.x, f.pos.y);
                    f.remove();
                    score += 1;
                } else {
                    life -= 1;
                    showHitEffect(player.pos.x, player.pos.y);
                    if (life <= 0) {
                        isGameOver = true;
                        player.vel.set(0, 0);
                    } else {
                        invincible = true;
                        invincibleTimer = frameCount;
                        player.pos.set(100, floor.pos.y - playerImg.height * player.scale / 2);
                    }
                }
            });

            if (!(invincible || powerUp) && player.pos.y > height) {
                life -= 1;
                showHitEffect(player.pos.x, player.pos.y);
                if (life <= 0) {
                    isGameOver = true;
                    player.vel.set(0, 0);
                } else {
                    invincible = true;
                    invincibleTimer = frameCount;
                    player.pos.set(100, floor.pos.y - playerImg.height * player.scale / 2);
                }
            }

            player.overlap(items, (p, item) => {
                powerUp = true; powerUpTimer = frameCount;
                showItemEffect(item.pos.x, item.pos.y);
                item.remove();
            });

            if (powerUp && frameCount - powerUpTimer > 180) powerUp = false;
            if (invincible && frameCount - invincibleTimer > 60) invincible = false;

            player.visible = !(invincible || powerUp) || frameCount % 10 < 5;

            for (let i = hitEffects.length - 1; i >= 0; i--) {
                let h = hitEffects[i];
                if (h.alpha <= 0) { hitEffects.splice(i, 1); continue; }
                fill(h.color ? h.color : [255, 100, 0], h.alpha);
                ellipse(h.x, h.y, h.size);
                h.alpha -= 5;
            }
        }

        function keyPressed() {
            if (isGameOver && key === ' ') {
                isGameOver = false;
                score = 0; life = 3; powerUp = false; invincible = false;
                invincibleTimer = 0; powerUpTimer = 0; hitEffects = [];
                player.pos.set(100, floor.pos.y - playerImg.height * player.scale / 2);
                player.vel.set(0, 0); player.visible = true; player.tint = color(255, 255, 255);

                for (let i = enemies.length - 1; i >= 0; i--) enemies[i].remove();
                for (let i = fallingEnemies.length - 1; i >= 0; i--) fallingEnemies[i].remove();
                for (let i = items.length - 1; i >= 0; i--) items[i].remove();
            }
        }
    </script>
</body>

</html>