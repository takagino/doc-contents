<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>p5play</title>
  <style>
    canvas {
      border: 1px solid #aaa;
    }
  </style>
</head>

<body>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.11.4/lib/p5.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.11.4/lib/addons/p5.sound.min.js"></script>
  <!-- planck -->
  <script src="https://cdn.jsdelivr.net/npm/planck@latest/dist/planck.min.js"></script>
  <!-- Version 3 of p5.play -->
  <script src="https://p5play.org/v3/p5play.js"></script>
  <script>
    let player, floor;
    let enemies;
    let isGameOver = false;
    let isGameClear = false;
    let timeLeft = 30;
    let playerImg, enemyImg;

    function preload() {
      playerImg = loadImage('player.svg');
      enemyImg = loadImage('enemy.svg');
    }

    function setup() {
      createCanvas(640, 480);
      world.gravity.y = 10;

      floor = new Sprite(width / 2, 400, width, 30);
      floor.color = '#666';
      floor.collider = 'static';

      player = new Sprite(250, 360);
      player.image = playerImg;
      player.scale = 0.1;

      player.jumpCount = 0;
      player.spinTimer = 0;

      enemies = new Group();
      enemies.image = enemyImg;
      enemies.collider = 'kinematic';
      enemies.scale = 0.15;
    }

    function draw() {
      background(255);

      if (isGameOver) {
        fill(0);
        textSize(50);
        textAlign(CENTER);
        text('GAME OVER', width / 2, height / 2);
        return;
      }

      if (timeLeft <= 0) {
        isGameClear = true;
        fill(0);
        textSize(50);
        textAlign(CENTER);
        text('GAME CLEAR!', width / 2, height / 2);
        return;
      }

      timeLeft -= deltaTime / 1000;
      if (timeLeft < 0) timeLeft = 0;

      fill(0);
      textSize(24);
      textAlign(LEFT, TOP);
      text('Time: ' + nf(timeLeft, 2, 2), 10, 10);


      if (kb.pressing('right')) {
        player.vel.x = 5;
      } else if (kb.pressing('left')) {
        player.vel.x = -5;
      } else {
        player.vel.x = 0;
      }

      if (player.x < 0) {
        player.x = 0;
      }
      if (player.x > width) {
        player.x = width;
      }


      if (player.colliding(floor)) {
        player.jumpCount = 0;
      }

      if (player.colliding(floor) && kb.pressing('space')) {
        player.vel.y = -6;
        player.jumpCount = 1;
      }
      else if (kb.presses('space') && player.jumpCount < 2) {
        player.vel.y = -6;
        player.jumpCount++;
      }

      if (kb.presses('enter') && player.spinTimer <= 0) {
        player.spinTimer = 50;
        player.rotationSpeed = 20;
      }

      if (player.spinTimer > 0) {
        player.spinTimer--; // タイマーを減らす
        if (player.spinTimer <= 0) {
          player.rotationSpeed = 0;
          player.rotation = 0;
        }
      } else {
        player.rotation = 0;
      }

      if (frameCount % 20 === 0) {
        let enemyY = random(150, 400);
        let enemy = new enemies.Sprite(width, enemyY);
        enemy.vel.x = -20;
      }

      enemies.cull(100);

      player.collides(enemies, (p, e) => {
        if (player.spinTimer > 0) {
          e.remove();
          timeLeft -= 2;
        } else {
          isGameOver = true;
          player.tint = '#666';
        }
      });
    }
  </script>
</body>

</html>