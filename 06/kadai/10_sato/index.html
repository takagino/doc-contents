<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>応用：避けゲー</title>

    <style>
      canvas {
        display: block;

        border: 1px solid #aaa;
        margin: 20px auto;
      }
    </style>
  </head>

  <body>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.11.4/lib/p5.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.11.4/lib/addons/p5.sound.min.js"></script>
    <!-- planck -->
    <script src="https://cdn.jsdelivr.net/npm/planck@latest/dist/planck.min.js"></script>
    <!-- Version 3 of p5.play -->
    <script src="https://p5play.org/v3/p5play.js"></script>

    <script>
      let player, floor;
      let enemies;
      let obstacles;
      let isGameOver = false;
      let score = 0;

      let myFont;
      let playerImg;
      let enemyImg;
      let obstacleImg;

      function preload() {
        myFont = loadFont("myFont.ttf");
        playerImg = loadImage("player.svg");
        enemyImg = loadImage("enemy.svg");
        obstacleImg = loadImage("obstacle.svg");
      }

      function setup() {
        createCanvas(640, 480);
        world.gravity.y = 10;

        player = new Sprite(100, 350);
        player.image = playerImg;
        player.scale = 0.1;
        player.layer = 2;

        floor = new Sprite(320, 400, 520, 30);
        floor.color = "#8c7b77";
        floor.collider = "static";
        floor.layer = 1;

        enemies = new Group();
        enemies.image = enemyImg;
        enemies.collider = "kinematic";
        enemies.scale = 0.1;

        obstacles = new Group();
        obstacles.image = obstacleImg;
        obstacles.scale = 0.1;
        obstacles.collider = "kinematic"; // 移動させるだけで当たり判定あり
      }

      function draw() {
        background(255);
        textFont(myFont);

        if (!isGameOver) {
          fill(0);
          textSize(24);
          text("スコア　" + score, 50, 100);
          textSize(20);
          text("全て避けよう！", 50, 70);
        }

        if (!isGameOver && player.y > height + 50) {
          isGameOver = true;
          player.tint = "#666";
        }

        if (isGameOver) {
          fill(0);
          textFont(myFont);
          textSize(50);
          textAlign(CENTER);
          text("GAME OVER", width / 2, height / 2);

          textSize(20);
          text("スコア　" + score, width / 2, height / 2 + 50);

          text("ENTERキーでリスタートできます", width / 2, height / 2 + 100);

          if (kb.presses("enter")) {
            restartGame();
            return;
          }

          return;
        }

        if (kb.pressing("right")) {
          player.vel.x = 5;
        } else if (kb.pressing("left")) {
          player.vel.x = -5;
        } else {
          player.vel.x = 0;
        }

        if (kb.presses("up") && player.colliding(floor)) {
          player.vel.y = -5;
        }

        if (frameCount % 120 === 0) {
          let enemy = new enemies.Sprite(width, 380);
          enemy.vel.x = -random(4, 9);
          enemy.scored = false;
        }

        if (score >= 5 && frameCount % 180 === 0) {
          let obs = new obstacles.Sprite(random(50, width - 50), -20);
          obs.vel.y = random(3, 6);
          obs.life = 200;
        }

        for (let enemy of enemies) {
          if (!enemy.scored && player.x > enemy.x && !player.colliding(enemy)) {
            score++;
            enemy.scored = true;
          }
        }

        enemies.cull(100);

        if (player.collides(enemies)) {
          isGameOver = true;
          player.tint = "#666";
        }
      }

      function restartGame() {
        isGameOver = false;
        score = 0;
        player.x = 100;
        player.y = 350;
        player.vel.x = 0;
        player.vel.y = 0;
        player.rotation = 0;
        player.tint = color(255);
        enemies.removeAll();
        textAlign(LEFT);
      }
    </script>
  </body>
</html>
