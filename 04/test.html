<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D3.js Test</title>
  <style>
    #chart svg {
      width: 100%;
      height: auto;
      background-color: #eee;
    }

    #chart {
      margin-top: 10px;
    }
  </style>
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
  <button id="btn23" data-key="year2023">2023</button>
  <button id="btn24" data-key="year2024">2024</button>
  <button id="btn25" data-key="year2025">2025</button>

  <div id="chart"></div>

  <script>
    const initData = "year2023"; // 初期表示のデータセットキー

    /* --- グラフ初期化・描画関数 --- */
    // データセットを受け取り、グラフを描画・設定するメインの関数
    const initChart = (dataset) => {
      /* --- スケールの設定 --- */
      // 全データから val の値だけを抽出し、一つの配列にまとめる
      const allValues = [
        ...dataset.year2023.map(d => d.val),
        ...dataset.year2024.map(d => d.val),
        ...dataset.year2025.map(d => d.val)
      ];

      // 配列全体から最大値を見つける
      const maxValue = d3.max(allValues);

      // 線形スケール（数値データを視覚的な長さ等に変換する関数）を作成
      const xScale = d3
        .scaleLinear()
        .domain([0, maxValue]) // 入力値の範囲（0からデータの最大値まで）
        .range([0, 500 - 100]); // 出力値の範囲（0pxからグラフ描画幅まで）

      /* --- SVG要素の準備 --- */
      // #chart要素を選択し、SVG要素を追加して基本設定を行う
      const svg = d3.select("#chart")
        .append("svg")
        .attr("viewBox", "0 0 500 300"); // SVGの内部座標系を設定

      /* --- グラフ更新関数 --- */
      // 指定された年のデータ (yearData) に基づいてグラフの値を更新する関数
      const updateValues = (yearData) => {

        // データと<g>要素（グループ化要素）を紐付ける
        const g = svg.selectAll('.item')
          // 読み込んだデータ配列を紐付け
          // 同時にキー関数を指定して、データの識別に label プロパティを使用（動作安定）
          .data(yearData, (d) => d.label)
          .join(
            enter => { // Enter: 新しい<g>を追加
              const gEnter = enter.append('g')
                .classed('item', true);

              // 各<g>要素の中に初期状態の要素を追加
              gEnter.append('rect')
                .attr('x', 0)
                .attr('height', 20)
                .attr('fill', (d) => d.color)
                .attr('width', 0);

              gEnter.append('text')
                .classed('label', true)
                .attr('font-size', '14')
                .attr('x', 0)
                .attr('y', 14)
                .text((d) => d.label);

              gEnter.append('text')
                .classed('value', true)
                .attr('font-size', '14')
                .attr('x', 0)
                .attr('y', 14)
                .text((d) => d.val);

              return gEnter; // 生成した<g>要素のセットを返す
            }
          )
          .attr('transform', (d, i) => `translate(0, ${i * 30})`);

        // --- <g>要素の中身 (rect, text) の属性を更新 ---
        // 棒グラフ (rect) の更新
        g.select('rect')
          .transition()
          .duration(500)
          .delay(300)
          .ease(d3.easeLinear)
          .attr('width', (d) => xScale(d.val))
          .attr('fill', (d) => d.color);

        // ラベル (text.label) の更新
        g.select('.label')
          .text(d => d.label)
          .transition()
          .duration(500)
          .delay(300)
          .ease(d3.easeLinear)
          .attr('x', (d) => xScale(d.val));

        // 値 (text.value) の更新
        g.select('.value')
          .text(d => d.val)
      };

      /* --- イベントリスナーの設定 --- */
      // HTML内の全てのbutton要素を取得し、クリックイベントを設定
      const btn = document.querySelectorAll('button');
      btn.forEach((elem) => {
        elem.addEventListener('click', () => {
          // クリックされたボタンの data-key 属性に対応するデータを渡して更新関数を実行
          updateValues(dataset[elem.dataset.key]);
        });
      });

      /* --- 初期表示 --- */
      // ページ読み込み時に最初のデータセットでグラフを描画
      updateValues(dataset[initData]);
    }

    /* --- データ読み込み --- */
    // 外部のJSONファイルを非同期で読み込む
    d3.json('./data.json')
      .then((dataset) => { // データの読み込みが成功したら、以下の処理を実行
        initChart(dataset);
      })
      .catch((error) => { // データ読み込み失敗時の処理
        console.error('データの読み込みに失敗しました:', error);
      });
  </script>
</body>
</html>
