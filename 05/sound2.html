<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>p5.sound.js</title>
    <style>
      canvas {
        border: 1px solid #aaa;
      }
    </style>
  </head>
  <body>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.11.11/lib/p5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.11.11/lib/addons/p5.sound.js"></script>
    <script>
      let mySound;
      let fft;

      // インスタンスを格納するための配列
      let rotators = [];
      // グリッドの1マスのサイズ
      const gridSize = 40;
      // 矩形の基本サイズ
      const rectSize = 30;

      // --- 1. 音声ファイルの読み込み ---
      function preload() {
        mySound = loadSound('groove.mp3');
      }

      // --- 2. 初期設定 ---
      function setup() {
        createCanvas(640, 480);
        colorMode(HSL);
        rectMode(CENTER);
        angleMode(DEGREES);
        fill(0, 80, 70, 0.6);
        noStroke();

        // FFTオブジェクトを作成
        fft = new p5.FFT();

        // 2重のforループで格子状にインスタンスを生成
        for (let y = 0; y < height; y += gridSize) {
          for (let x = 0; x < width; x += gridSize) {
            // 各グリッドの中心座標に、Rotatorインスタンスを生成
            let r = new Rotator(x + gridSize / 2, y + gridSize / 2, rectSize);
            // 配列に追加
            rotators.push(r);
          }
        }
      }

      // --- 3. 毎フレームの描画 ---
      function draw() {
        background(0, 0, 100); // 毎フレーム白で塗りつぶす

        if (mySound.isPlaying()) {
          // 周波数スペクトル（1024個の0〜255の値）を取得
          let spectrum = fft.analyze();

          // 配列内のすべてのインスタンスに対して処理を実行
          for (let i = 0; i < rotators.length; i++) {
            // ★ 各インスタンスに対応する周波数帯の音量を取得
            // インスタンスの番号(i)を、スペクトルのインデックス(0〜1023)にマッピング
            let spectrumIndex = floor(
              map(i, 0, rotators.length, 0, spectrum.length)
            );
            let amplitude = spectrum[spectrumIndex]; // 0〜255の音量

            rotators[i].update(amplitude); // ★ 音量データを渡して更新
            rotators[i].draw();
          }
        }
      }

      // --- 4. ユーザー操作 ---
      function mousePressed() {
        // クリックで再生/停止を切り替え
        if (mySound.isPlaying()) {
          mySound.pause();
        } else {
          mySound.loop();
        }
      }

      // --- Rotatorクラス（設計図）の定義 ---
      class Rotator {
        constructor(startX, startY, baseSize) {
          this.x = startX;
          this.y = startY;
          this.baseSize = baseSize; // ★ 基本サイズとして保存
          this.currentSize = baseSize; // ★ 音量で変化する現在のサイズ
          this.angle = 0;
          this.noiseOffset = random(1000); // ★ 各インスタンス固有のノイズ開始点
        }

        // ★ updateメソッドで音量データ(amplitude)を受け取る
        update(amplitude) {
          // 1. 角度の更新
          this.noiseOffset += 0.005;
          this.angle = noise(this.noiseOffset) * 360;

          // 2. 大きさの更新
          // 音量(0〜255)を、5pxからマスの1.5倍のサイズにマッピング
          this.currentSize = map(amplitude, 0, 255, 5, gridSize * 1.5);
        }

        draw() {
          push();
          translate(this.x, this.y);
          rotate(this.angle);
          rect(0, 0, this.currentSize, this.currentSize); // ★ currentSizeで描画
          pop();
        }
      }
    </script>
  </body>
</html>
